<% layout('layouts/layout') %>

<h2 class="mb-4">Historial de ventas</h2>

<div class="row g-3 mb-4">
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-3">Buscar cliente por ID</h5>
        <form class="row g-2" action="/historial-ventas/buscar-cliente" method="get">
          <div class="col-8">
            <input type="number" name="id" class="form-control" placeholder="ID del cliente" required min="1">
          </div>
          <div class="col-4">
            <button class="btn btn-outline-primary w-100">Buscar</button>
          </div>
        </form>

        <% if (clienteBuscado && clienteBuscado !== 'null') { %>
          <hr>
          <div>
            <div class="fw-bold">Cliente #<%= clienteBuscado.id %>: <%= clienteBuscado.nombre %></div>
            <% if (clienteBuscado.correo) { %><small class="d-block text-muted">Correo: <%= clienteBuscado.correo %></small><% } %>
            <% if (clienteBuscado.telefono) { %><small class="d-block text-muted">Teléfono: <%= clienteBuscado.telefono %></small><% } %>
          </div>
        <% } else if (clienteBuscado === 'null') { %>
          <hr>
          <div class="alert alert-warning mb-0">No se encontró cliente con ese ID.</div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-3">Resumen</h5>
        <p class="mb-1">Ventas totales: <strong><%= ventas.length %></strong></p>
        <p class="mb-0">Monto total: <strong>$<%= ventas.reduce((acc,v)=>acc + Number(v.total||0),0).toFixed(2) %></strong></p>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Listado</h5>
      <a class="btn btn-sm btn-outline-secondary" href="http://localhost:3030/api/repuestos/json" target="_blank" rel="noopener">
        Ver JSON de repuestos (API)
      </a>
    </div>

    <% if (error) { %>
      <div class="alert alert-danger">No se pudo cargar el historial.</div>
    <% } %>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Repuesto</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% if (!ventas || ventas.length === 0) { %>
            <tr><td colspan="7" class="text-center"><em>Sin ventas registradas.</em></td></tr>
          <% } %>
          <% (ventas || []).forEach(v => { %>
            <tr>
              <td><%= v.id %></td>
              <td><small><%= new Date(v.createdAt || v.fecha).toLocaleString() %></small></td>
              <td>
                <% if (v.Cliente) { %>
                  <div class="fw-semibold"><%= v.Cliente.nombre %></div>
                  <% if (v.Cliente.correo) { %><small class="text-muted"><%= v.Cliente.correo %></small><% } %>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
              <td>
                <% if (v.Repuesto) { %>
                  <div class="fw-semibold"><%= v.Repuesto.nombre %></div>
                  <small class="text-muted">ID: <%= v.Repuesto.id %></small>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
              <td><%= v.cantidad %></td>
              <td>$<%= Number(v.Repuesto?.precio || 0).toFixed(2) %></td>
              <td class="fw-semibold">$<%= Number(v.total || 0).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>
